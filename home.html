<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>首页</title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/index.css" rel="stylesheet" />
		<link href="../icomoon/style.css" rel="stylesheet" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/4.0.2/css/swiper.min.css">
		<style>
			.clearfix {
				clear: both;
			}

			.message {
				width: 25px;
				height: 22px;
				margin-top: 10px;
			}

			.target {
				width: 95%;
				position: absolute;
				left: 2.5%;
				right: 2.5%;
				top: 163px;
				color: #000000;
				background-color: #FFFFFF;
				border-radius: 8px;
				box-shadow: 0 -8px 18px 2px #1B86E2;
			}

			ul,
			li {
				list-style: none;
			}

			.titlecontent {
				margin-top: 55px;
			}

			.titlecontentL {
				width: 50%;
				float: left;
				text-align: center;
			}

			.titlecontent li {
				float: left;
				width: 50%;
			}

			.titlecontentL li img {
				height: 24px;
			}

			.titlecontentR {
				width: 50%;
				float: right;
			}

			.titlecontentR p {
				float: left;
				margin-top: 10px;
				margin-left: 10px;
				font-size: 12px;
				margin-right: 10px;
			}

			.titlecontent p {
				color: #000000;
			}

			.Notice {
				height: 41px;
				overflow: hidden;
				margin-top: 77px;
				padding: 10px;
				font-size: 12px;
				color: #000000;
				background-color: #DDDEDE;
				display: none;
			}

			.Notice-title {
				float: left;
			}

			.Notice span {
				float: left;
				margin-left: 15px;
			}

			.Notice img {
				float: right;
				width: 8px;
				margin-top: 3px;
			}

			.Background-picture {
				position: relative;
				text-align: center;
			}

			.Background-picture h4 {
				position: absolute;
				top: 46%;
				left: 10%;
				right: 10%;
				font-size: 18px;
			}

			.function {
				width: 90%;
				position: absolute;
				margin-top: -35px;
				margin-left: 5%;
				border-radius: 8px;
				padding: 15px 0 15px 0;
				box-shadow: 0 0 15px 1px #D6D7D9;
				background-color: #fff;
			}

			.functionL {
				width: 50%;
				float: left;
			}

			.functionLc {
				width: 60%;
				color: #000000;
				margin: 0 auto;
				text-align: center;
			}

			.function img {
				height: 18px;
				float: left;
				margin-top: 10px;
			}

			.function p {
				float: left;
				color: #000000;
				margin-left: 15px;
				font-size: 15px;
				margin-top: 10px;
			}

			.functionR {
				width: 50%;
				float: right;
				border-left: 1px solid #F2F2F2;
			}

			.functionRc {
				width: 40%;
				color: #000000;
				margin: 0 auto;
				text-align: center;
			}

			.functional_selection {
				width: 90%;
				margin: 0 auto;
				margin-top: 37px;
				text-align: left;
			}

			.business_card {
				width: 48%;
				padding: 15px 10px;
				float: left;
				margin-top: 25px;
				border-radius: 7px;
				box-shadow: 0 0 15px 1px #D1D1D3;
				background-color: #fff;
				overflow: hidden;
			}

			.business_cardR {
				width: 48%;
				padding: 15px 10px;
				float: right;
				margin-top: 25px;
				border-radius: 7px;
				box-shadow: 0 0 15px 1px #D1D1D3;
				background-color: #fff;
				overflow: hidden;
			}

			.functional_selection img {
				width: 48px;
				float: left;
			}

			.functional_selection p {
				font-size: 15px;
				color: #000;
				margin-top: 5px;
			}

			.functional_selection span {
				font-size: 11px;
				display: block;
				margin-top: -8px;
			}

			#quick {
				width: 80%;
				margin: 0 auto;
				box-shadow: 0 0 15px 3px #D1D1D3;
				border-radius: 20px;
				background-color: #fff;
				display: none;
				margin-top: -133px;
				z-index: 9999;
			}

			#quick li {
				width: 25%;
				float: left;
				margin-top: 15px;
			}

			#quick li img {
				height: 22px;
			}

			#quick li p {
				font-size: 10px;
				color: #000000;
			}

			.jiandou {
				width: 19px;
				position: absolute;
				margin-left: -12px;
			}

			#back {
				position: fixed;
				top: 0;
				left: 0;
				display: none;
				width: 100%;
				height: 100%;
				opacity: 0.5;
			}

			#cover {
				position: fixed;
				z-index: 9999;
				top: 0;
				left: 0;
				display: none;
				width: 100%;
				height: 100%;
				opacity: 0.5;
				background: #484848 none repeat scroll 0% 0%;
			}
			
			.code_container {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.5)!important;
				z-index: 99998;
				display: none;
			}
			
			#QR-code {
				width: 74%;
				height: 335px;
				background-color: #fff;
				z-index: 99999;
				position: fixed;
				top: 25%;
				left: 13%;
				border-radius: 8px;
				text-align: center;
			}

			.QR-tu {
				width: 217px;
				height: 217px;
				margin: 0 auto;
				padding-top: 30px;
			}

			.QR-tu img {
				width: 100%;
			}

			#QR-code span {
				display: block;
				font-size: 15px;
				margin-top: 50px;
				color: #000000;
				padding-bottom: 10px;
			}

			#QR-code a {
				font-size: 13px;
			}
			
			.mask {
				height: 100%;
				width: 100%;
				position: absolute;
				top: 0;
				background: #000000;
			}
			
			.mui-slider-title {
				position: absolute;
				bottom: -40%;
				left: 0;
				width: 100%;
				height: 100%;
				line-height: 30px;
				margin: 0;
				text-align: center;
				vertical-align: middle;
				text-indent: 0;
				opacity: 1;
				background-color: rgba(0, 0, 0, 0);
				color: #FFF;
				font-size: 18px;
			}
			
			.noticeMsg {
				overflow: hidden;
				white-space: nowrap;
				height: 50px;
				width: 100%;
				font-size: 15px;
				-webkit-transition: .4s;
				-o-transition: .4s;
				transition: .4s;
				-webkit-transform: translate3d(0, 0, 0);
				transform: translate3d(0, 0, 0);
				background: url(../Images/notice.png) left 10px center no-repeat;
			}
			
			.noticeMsg ul li {
				padding: 0;
				margin: 0;
			}
			
			#scroll_begin li, #scroll_end li {
				line-height: 32px;
				text-indent: 30px;
			}
		</style>
	</head>
	<body>
		<div style="margin-bottom: 50px;">
			<header class="mui-bar mui-bar-nav" style="height:120px; background-color: #fff;box-shadow: 0 0 0 #fff;">
				<img src="../image/index-message-icon.png" alt="" class="mui-pull-left" style="width: 25px;height: 22px;margin-top: 11px;">
				<h1 class="mui-title">旺客</h1>
				<img src="../image/index-add-icon.png" class="mui-pull-right" style="width: 20px;height: 20px;margin-top: 11px;">
				<div class="titlecontent">
					<div class="titlecontentL">
						<li id="scan">
							<img src="../image/index-scan.png">
							<p>扫一扫</p>
						</li>
						<!-- <a href="html/payment_code.html"> -->
							<li id="payment_code">
								<img src="../image/index-receipt-code.png">
								<p>收款码</p>
							</li>
						<!-- </a> -->
						<div class="clearfix"></div>
					</div>
					<div class="titlecontentR">
						<p id="city">昆明</p>
						<!-- <div class="icon sun-shower">
							<div class="cloud"></div>
							<div class="sun">
								<div class="rays"></div>
							</div>
							<div class="rain"></div>
						</div> -->
						<div id="weather_img" style="margin-left: 10px;"></div>
						<span style=" width: 60px;text-align: center; color: #000000;display: block;float: right;font-size: 12px;margin-top: -55px;">今天</span>
						<span style=" width: 60px;text-align: center; color: #000000;display: block;float: right;font-size: 12px;margin-top: -35px;"><font id="temperature">1°~7°</font></span>
						<span style=" width: 60px;text-align: center; color: #000000;display: block;float: right;font-size: 12px;margin-top: -15px;"><font id="weather">晴</font></span>
					</div>
					<div class="clearfix"></div>
				</div>
			</header>
			<div class="mui-content">
				<div class="Notice">
					<div class="Notice-title"><img src="../image/notice4.png" style="width:18px" alt=""></div>
					<span id="notice_container"></span>
					<img src="../image/iconrighth.png">
					<div class="clearfix"></div>
				</div>
				
				<div class="mui-slider" id="slider_container">
					<!-- <div class="mui-slider-group">
						<div class="mui-slider-item"><a href="#"><img src="../image/bj.jpg" /><p class="mui-slider-title">只要精神不滑坡,办法总比困难多</p></a></div>
					</div> -->
				</div>

				<div class="function" style="z-index: 1;">
					<div class="functionL">
						<div class="functionLc" data-type="setting">
							<img src="../image/idnex-message.png">
							<p>码上成交</p>
							<div class="clearfix"></div>
						</div>
					</div>
					<div class="functionR" id="setting">
						<a href="javascript: void(0);">
							<div class="functionRc">
								<img src="../image/Set-up.png">
								<p>设置</p>
								<div class="clearfix"></div>
							</div>
						</a>
					</div>
					<div class="clearfix"></div>
				</div>

				<div class="functional_selection">
					<div class="business_card" data-type="card">
						<img src="../image/business-card.png">
						<div style="float: left;margin-left: 10px;">
							<p>扫码换名片</p>
							<span style="color: #000;">科技范自我介绍</span>
						</div>
						<div class="heitiao">雷达</div>
						<div class="clearfix"></div>
					</div>
					<div class="business_cardR" data-type="redpacket">
						<img src="../image/Red-envelopes.png">
						<div style="float: left;margin-left: 15px;">
							<p>发红包</p>
							<span style="color: #000;">特色营销方式</span>
						</div>
						<div class="heitiao" style="background-color: #FC7053;">设置</div>
						<div class="clearfix"></div>
					</div>
					<div class="business_card" data-type="shop">
						<img src="../image/Shopping-Mall.png">
						<div style="float: left;margin-left: 15px;">
							<p>商城</p>
							<span style="color: #000;">个性化小程序</span>
						</div>
						<div class="clearfix"></div>
					</div>
					<div class="business_cardR" data-type="link">
						<img src="../image/custom.png">
						<div style="float: left;margin-left: 15px;">
							<p>自定义</p>
							<span style="color: #000;">营销多元化</span>
						</div>
						<div class="heitiao" style="background-color: #05D6DF;">设置</div>
						<div class="clearfix"></div>
					</div>
					<div class="clearfix"></div>
				</div>
			</div>
		</div>
		<div class="code_container">
			<div id="QR-code">
				<div class="QR-tu">
					<img src="../image/QR.png" id="qrcode_pic">
				</div>
				<span>二维码类型（<i id="qrcode_type">名片</i>）</span>
				<a id="qrcode_setting" style="float: left;margin-left: 45%;">设置 ></a>
				<img id="hide_qrcode" src="../image/Close.png" style="width: 28px;height: 28px;float: left;margin-top: 50px;margin-left: 45%;">
				<div class="clearfix"></div>
			</div>
		</div>
	</body>
	<script src="../js/mui.js"></script>
	<script src="../js/util.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/4.0.2/js/swiper.min.js"></script>
	<script>
		mui.init({
			swipeBack: false,
			pullRefresh: {
				container: "body",	//下拉刷新容器标识，querySelector能定位的css选择器均可，比如：id、.class等
                down: {
					height:50,//可选,默认50.触发下拉刷新拖动距离,
					auto: false,//可选,默认false.首次加载自动下拉刷新一次
					contentdown: "下拉可以刷新",//可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
					contentover: "释放立即刷新",//可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
					contentrefresh: "正在刷新...",//可选，正在刷新状态时，下拉刷新控件上显示的标题内容
					callback: function(){
						getNotice();
						weatherInit();	//天气初始化
						slideInit(true);	//幻灯片初始化 
                    }	
                }
			}
		});
			
		var noticeLen = 0;
		var noticeIndex = 0;
		var notice = {};
		var qrType = 'card';
		var userInfo = getUserInfo();
		mui.plusReady(function() {
			getNotice();
			weatherInit();	//天气初始化
			slideInit(false);	//幻灯片初始化 
			
			//打开扫一扫
			var scan = document.getElementById('scan');
			scan.addEventListener('tap', function() {
				var paymentPage = plus.webview.create('scan.html', 'scan', {top: '0', bottom: '0', scrollIndicator: 'none', statusbar: {background: '#000'}});
				paymentPage.show('slide-in-right');
				setStatusBar('#2289FF', 'light');
			});
			
			//打开收款码页面
			var payment_code = document.getElementById('payment_code');
			payment_code.addEventListener('tap', function() {
				var paymentPage = plus.webview.create('payment_code.html', 'payment_code', {top: '0', bottom: '0', scrollIndicator: 'none', statusbar: {background: '#2289FF'}});
				paymentPage.show('slide-in-right');
				setStatusBar('#2289FF', 'light');
			});
			
			//打开设置界面
			document.getElementById('setting').addEventListener('tap', function() {
				var settingPage = plus.webview.create('qrcode_setting.html', 'qrcode_setting', {top: '0', bottom: '0', scrollIndicator: 'none', statusbar: {background: '#2289FF'}});
				settingPage.show('slide-in-right');
				setStatusBar('#2289FF', 'light');
			})
			
			//打开二维码
			mui('.mui-content').on('tap', '.business_card,.business_cardR,.functionLc', function() {
				var type = this.dataset.type;
				showQrcode(type);
			})
			
			//关闭二维码
			document.getElementById('hide_qrcode').addEventListener('tap', function() {
				hideQrcode();
			})
			
			//查看公告
			mui('.mui-content').on('tap', '.Notice', function() {
				noticeDeail();
			})
			
			//设置二维码
			document.getElementById('qrcode_setting').addEventListener('tap', function() {
				qrcodeTypeSetting(qrType);
			})
		});
		
		//获取地理位置
		function weatherInit(){
			plus.geolocation.getCurrentPosition(function(p){
				getTodayWeather(p.coords.longitude + ',' + p.coords.latitude);
			}, function(e){
				mui.alert('Geolocation error: ' + e.message);
			} );
		}
		
		//获取轮播图
		function slideInit(refresh){
			mui.post($ajaxUrl + 'carousel', {position: 1}, function(res) {
				if (res.errno == 0) {
					var carousel = res.data;
					var len = carousel.length;
					var str = '';
					if (len == 1) {
						str += '<div class="mui-slider-group">';
						str += '<div class="mui-slider-item"><a href="' + carousel[0].link + '"><img src="' + carousel[0].pic + '" /><p class="mui-slider-title">' + carousel[0].title + '</p></a></div>';
						str += '</div>';
					} else {
						str += '<div class="mui-slider-group mui-slider-loop">';
						str += '<div class="mui-slider-item mui-slider-item-duplicate"><a href="' + carousel[len-1].link + '"><img src="' + carousel[len-1].pic + '" /><p class="mui-slider-title">' + carousel[len-1].title + '</p></a></div>';
						for (var i = 0; i < len; i++) {
							str += '<div class="mui-slider-item"><a href="' + carousel[i].link + '"><img src="' + carousel[i].pic + '" /><p class="mui-slider-title">' + carousel[i].title + '</p></a></div>';
						}
						str += '<div class="mui-slider-item mui-slider-item-duplicate"><a href="' + carousel[0].link + '"><img src="' + carousel[0].pic + '" /><p class="mui-slider-title">' + carousel[0].title + '</p></a></div>';
						str += '</div>';
					}
					document.getElementById('slider_container').innerHTML = str;
					setTimeout(function() {
						sliderPlay();
					}, 2000);
				} else {
					console.log(res.message);
				}
				setTimeout(function() {
					plus.nativeUI.closeWaiting();
				}, 1000)
				if (refresh) {
					setTimeout(function() {
						mui('body').pullRefresh().endPulldownToRefresh();
					}, 1000)
				}
			}, 'json')
		}
		
		//获取当前天气
		function getTodayWeather(LatandLong) {
			var baidukey='S4Z3Zvt623P9TMYDOLF041qMLwxGl2vg';
			var jsonUrl = "http://api.map.baidu.com/telematics/v3/weather?location=" + LatandLong + "&output=json&ak=" + baidukey + "";
			mui.ajax(jsonUrl, {
				dataType: 'json',
				type: 'get',
				//timeout: 10000,
				success: function(data) {
					if(data.status == "success") {
						//console.log(JSON.stringify(data));
						document.getElementById('city').innerHTML = data.results[0].currentCity;
						document.getElementById('temperature').innerHTML = data.results[0].weather_data[0].temperature;
						document.getElementById('weather').innerHTML = data.results[0].weather_data[0].weather;
						var weather = data.results[0].weather_data[0].weather;
						var str = '';
						if (weather.indexOf("晴") != -1) {
							if (weather.indexOf("云") != -1) {
								str += '<div class="icon sun-shower"><div class="cloud"></div><div class="sun"><div class="rays"></div></div></div>';
							} else if (weather.indexOf("雨") != -1) {
								str += '<div class="icon sun-shower"><div class="cloud"></div><div class="sun"><div class="rays"></div></div><div class="rain"></div></div>';
							} else {
								str += '<div class="icon sun-shower"><div class="sun"><div class="rays"></div></div></div>';
							}
						} else {
							if (weather.indexOf("云") != -1) {
								if (weather.indexOf("雨") != -1) {
									str += '<div class="icon rainy"><div class="cloud"></div><div class="rain"></div></div>';
								} else {
									str += '<div class="icon cloudy"><div class="cloud">< /div><div class="cloud"></div></div>';
								}
							}
							if (weather.indexOf("雪") != -1) {
								str += '<div class="icon flurries"><div class="cloud"></div><div class="snow"><div class="flake"></div><div class="flake"></div></div></div>';
							}
						}
						document.getElementById('weather_img').innerHTML = str;
					}
				},
				error: function(xhr, type, error) {
					mui.toast("网络异常,请稍候再试");
				}
			});
		}
		
		//轮播图轮播设置
		function sliderPlay() {
			mui('.mui-slider').slider({
				interval: 2500//自动轮播周期，若为0则不自动播放，默认为0；
			});
		}
		
		//展示二维码
		function showQrcode(type) {
			if (type == 'shop') {
				checkMember();
				return;
			}
			mui.post($ajaxUrl + 'userqrcode&action=make_url', {type: type, token: userInfo.token}, function(res) {
				if (res.errno == 0) {
					var qrcodeType = {
						'redpacket': '红包',
						'card': '名片',
						'link': '自定义',
						'pic': '图片',
						'article': '文章红包',
						'shop': '商城'
					};
					if (res.data.type != 'shop') {
						document.getElementById('qrcode_setting').style.display = 'block';
						qrType = res.data.type;
					} else {
						document.getElementById('qrcode_setting').style.display = 'none';
					}
					var url = $ajaxUrl + 'userqrcode&action=make_qrcode&token=' + userInfo.token + '&url=' + res.data.url;
					document.getElementById('qrcode_type').innerHTML = qrcodeType[res.data.type];
					document.getElementById('qrcode_pic').setAttribute('src', url);
					document.getElementsByClassName('code_container')[0].style.display = 'block';
				} else if (res.errno == 1) {
					plus.nativeUI.toast(res.msg);
				} else if (res.errno == 2) {
					var settingPage = plus.webview.create('qrcode_setting.html', 'qrcode_setting', {top: '0', bottom: '0', scrollIndicator: 'none', statusbar: {background: '#2289FF'}});
					settingPage.show('slide-in-bottom');
					setStatusBar('#2289FF', 'light');
				}
			}, 'json');
		}
		
		//隐藏二维码
		function hideQrcode() {
			document.getElementsByClassName('code_container')[0].style.display = 'none';
		}
		
		//获取公告
		function getNotice(){
			mui.post($ajaxUrl + 'notice', {action: 'list'}, function(res) {
				if (res.errno == 0) {
					notice = res.data;
					noticeLen = notice.length;
					var str = '<div class="swiper-container"><div class="swiper-wrapper">';
					for (var i = 0; i < noticeLen; i++) {
						str += '<div class="swiper-slide notice_' + i + '" data-id="' + notice[i].id + '">' + notice[i].title + '</div>';
					}
					str += '</div></div>';
					document.getElementById('notice_container').innerHTML = str;
					document.getElementsByClassName('Notice')[0].style.display = 'block';
					scrollInit();
				} else {
					console.log(res.message);
				}
			}, 'json')
		}
		
		//公告滚动初始化
		function scrollInit() {
			var mySwiper = new Swiper('.swiper-container', {
				autoplay: true,	//可选选项，自动滑动
				loop : true,
				direction : 'vertical',
				speed: 5000,
				autoHeight: true,
				watchOverflow: true,
				on: {
					slideChange: function(){
						var index = this.activeIndex;
						if (index <= noticeLen) {
							noticeIndex = index - 1;
						} else {
							noticeIndex = 0;
						}
					},
				}
			})
		}
		
		//查看公告详情
		function noticeDeail() {
			var detailPage = plus.webview.create('notice_detail.html', 'notice_detail', {top: '0', bottom: '0', scrollIndicator: 'none', statusbar: {background: '#FFF'}}, {notice: notice[noticeIndex]});
			detailPage.show();
		}
		
		//设置二维码类型
		function qrcodeTypeSetting(type) {
			var newPage = plus.webview.create(type + '_setting.html', type + '_setting', {top: '0', bottom: '0', scrollIndicator: 'none', statusbar: {background: '#FFF'}}, {'from': 'home'});
			newPage.show('slide-in-bottom');
			hideQrcode();
		}
	</script>
</html> 
